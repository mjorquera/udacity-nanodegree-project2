"use strict";angular.module("publicTransportationApp",["ui.router","leaflet-directive","picardy.fontawesome","indexedDB"]).config(["$stateProvider","$urlRouterProvider","$indexedDBProvider",function(a,b,c){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"views/train.html",controller:"TrainCtrl as train"}),c.connection("station-app").upgradeDatabase(1,function(a,b,c){console.log(b);var d=b.createObjectStore("stations",{autoIncrement:!0});d.createIndex("code_idx","station_code",{unique:!0}),b.createObjectStore("trains",{keyPath:"station_code"})})}]).run(["$rootScope",function(a){"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.js").then(function(b){a.installing=!1,a.waiting=!1,a.active=!1,b.installing?(a.installing=!0,console.log("Service worker installing")):b.waiting?(a.waiting=!0,console.log("Service worker installed")):b.active&&(a.active=!0,console.log("Service worker active")),a.updateWorker=function(){console.log(b.waiting),b.waiting.postMessage({action:"skipWaiting"})}})["catch"](function(a){console.log("Registration failed with "+a)}),navigator.serviceWorker.addEventListener("controllerchange",function(){window.location.reload()}))}]),angular.module("publicTransportationApp").controller("TrainCtrl",["stationFinder","$indexedDB",function(a,b){var c=this;c.mapcenter={lat:51.498395,lng:-.120857,zoom:11},c.getStatusClass=function(a){switch(a){case"LATE":return"label-danger";case"ON TIME":return"label-success";case"STARTS HERE":return"label-primary";case"EARLY":return"label-success";default:return"label-default"}},c.selectDeparture=function(){if(null!==c.departure_id){var d=c.markers.filter(function(a){return a.id===c.departure_id})[0];"undefined"!=typeof d&&(d.focus=!0),c.departure=c.departure_stations.filter(function(a){return a.station_code===c.departure_id})[0]}null!==c.departure_id&&c.arrival_id!==c.departure_id&&(c.routeInfo=null,b.openStore("trains",function(b){b.find(c.departure_id).then(function(b){return b&&(console.log("Cached Data: "+b),c.routeInfo=b,c.offline=!0),a.getRouteInfo(c.departure_id,c.arrival_id)})["catch"](function(){return a.getRouteInfo(c.departure_id,c.arrival_id)}).then(function(b){b&&(console.log("New data avaliable: "+b),c.routeInfo=b,c.offline=!1,a.saveTrainCache(b))})["catch"](function(){console.log("Cannot retrieve online data.")})}))},c.selectArrival=function(){var b=c.markers.filter(function(a){return a.id===c.arrival_id})[0];"undefined"!=typeof b&&(b.focus=!0),c.arrival=c.arrival_stations.filter(function(a){return a.station_code===c.arrival_id})[0],null!==c.arrival_id&&null!==c.departure_id&&c.arrival_id!==c.departure_id&&(c.routeInfo=null,a.getRouteInfo(c.departure_id,c.arrival_id).then(function(a){console.log(a),c.routeInfo=a}))};var d=function(a){c.stations=a;var d=[];c.departure_stations=a,c.arrival_stations=a,$.each(a,function(a,c){b.openStore("stations",function(a){a.findBy("code_idx",c.station_code).then(function(b){b||a.upsert(c)["catch"](function(a){console.log(a)})})});var e={id:c.station_code,lat:c.latitude,lng:c.longitude,message:c.name+". Code: "+c.station_code,draggable:!1,focus:!1};0==a&&(e.focus=!0),d.push(e)}),c.markers=d};a.getCachedStations().then(function(b){return d(b),a.getStations()}).then(function(a){d(a)})}]),angular.module("publicTransportationApp").service("stationFinder",["$indexedDB",function(a){var b="03bf8009",c="d9307fd91b0247c607e098d5effedc97",d="https://transportapi.com/v3/uk/train/station/";this.getCachedStations=function(){return a.openStore("stations",function(a){return a.getAll()})},this.getStations=function(){return $.get("/data/stations.json")},this.getRouteInfo=function(a,e){var f=d+a+"/live.json?app_id="+b+"&app_key="+c;return"undefined"!=typeof e&&null!==e&&(f+="&calling_at="+e),f+="&darwin=false&train_status=passenger",$.get(f)},this.saveTrainCache=function(b){return a.openStore("trains",function(a){a.find(b.station_code).then(function(c){return c&&a["delete"](b.station_code),a.insert(b)})["catch"](function(){return a.insert(b)})})}}]),angular.module("publicTransportationApp").run(["$templateCache",function(a){a.put("views/train.html",'<div class="row"> <div class="col-sm-6"> <form> <div class="form-group"> <label>Departure Station</label> <select class="form-control" ng-model="train.departure_id" ng-change="train.selectDeparture()"> <option value="" disabled selected>(Select Departure Station)</option> <option ng-repeat="option in train.departure_stations | orderBy: \'name\'" ng-value="option.station_code">{{option.name}}</option> </select> </div> <div class="form-group"> <label>Arrival Station</label> <select class="form-control" ng-model="train.arrival_id" ng-change="train.selectArrival()"> <option value="" selected>(Select Arrival Station)</option> <option ng-repeat="option in train.arrival_stations | orderBy: \'name\'" ng-value="option.station_code">{{option.name}}</option> </select> </div> </form> <leaflet class="hidden-xs" center="train.mapcenter" markers="train.markers" path="train.paths" height="480px" style="width:100%"></leaflet> </div> <div class="col-sm-6"> <h4>From: <b>{{train.departure.name}} {{train.departure_id}}</b> <h4>To: <b>{{train.arrival.name}} {{train.arrival_id}}</b> <p class="text-right" ng-show="train.offline"><label class="label label-warning">Offline</label><small> data from: <b>{{train.routeInfo.request_time | date:"MM/dd/yyyy \'at\' h:mma"}}</b></small></p> <p class="text-right" ng-show="!train.offline"><label class="label label-success">Online</label></p> <table class="table table-hover table-responsive table-condensed"> <thead> <tr> <th>Train</th> <th>Platform</th> <th>Arrival Time</th> <th>Departure Time</th> <th>Arrives in</th> <th>Final Destination</th> <th>Status</th> </tr> </thead> <tbody> <tr ng-show="train.departure_id != null && train.routeInfo.departures.all == null"><td colspan="7" class="text-center"><fa name="refresh" spin size="2"></fa></td></tr> <tr ng-repeat="schedule in train.routeInfo.departures.all | orderBy: \'expected_departure_time\'"> <td><span class="label label-success"><fa name="train"></fa> {{schedule.train_uid}}</span></td> <td class="text-center"><span class="badge">{{schedule.platform}}</span></td> <td class="text-center"> <span ng-show="schedule.aimed_arrival_time == null">-</span> <div ng-hide="schedule.aimed_arrival_time == null"> {{schedule.aimed_arrival_time}} <br> <small class="opacity-4x">({{schedule.expected_arrival_time}})</small> </div> </td> <td class="text-center"> {{schedule.aimed_departure_time}} <br> <small class="opacity-4x">({{schedule.expected_departure_time}})</small> </td> <td class="text-center"><span ng-show="schedule.best_arrival_estimate_mins != null">{{schedule.best_arrival_estimate_mins}} mins</span></td> <td class="text-center">{{schedule.destination_name}}</td> <td class="text-center"><span class="label" ng-class="train.getStatusClass(schedule.status)">{{schedule.status}}</span></td> </tr> </tbody> </table> <div ng-if="train.routeInfo.departures.all.length == 0" class="text-center" ng-cloak> <p> <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> No route info available between <b>{{train.departure.name}}</b> and <b>{{train.arrival.name}}</b>. </p> </div> </h4></h4></div> </div>')}]);